---
sidebar_position: 2
---

# Данные инициализации

## Описание

В списке [параметров запуска](./about), данные инициализации располагаются в
параметре `tgWebAppData`. Они представляют собой набор данных по большей части
связанных с конкретным пользователем, запустившим приложение TWA.

Яркой особенностью данных инициализации является тот факт, что они могут
быть использованы как фактор аутентификации или авторизации. По этой причине
не стоит забывать и о безопасности приложения.

:::caution

Этот параметр не передается приложению TWA в случае, если оно было открыто
при помощи KeyboardButton (из клавиатуры в диалоге).

:::

## Извлечение

Для того чтобы извлечь данные инициализации, достаточно сначала получить
параметры запуска, после чего извлечь параметр `tgWebAppData` и поместить его
в конструктор `URLSearchParams`:

```typescript title="Пример извлечения данных инициализации"
// Получаем параметры запуска.
const params = new URLSearchParams(window.location.hash.slice(1));

// Конвертируем в более удобный вид.
const initDataString = params.get('tgWebAppData'); // user=...&query_id=...&...
const initData = new URLSearchParams(initDataString);
console.log(initData.get('query_id')); // jsHS198czozxk7s 
```

## Авторизация и аутентификация

Особенной чертой данных инициализации является возможность быть использованными
как фактор для авторизации или аутентификации. Дело в том, что сгенерированные
нативным приложением Telegram данные подписываются секретным ключом бота
Telegram, после чего сгенерированная подпись помещается рядом с самими
параметрами.

Таким образом, зная секретный ключ бота Telegram, у разработчика имеется
возможность проверить подпись параметров и убедиться, что они действительно
были выданы указанному пользователю.

Также, операция проверки подписи является достаточно быстрой и не требует
больших ресурсов сервера. Подробнее с алгоритмом подписи данных и верификации
можно ознакомиться
в [этой документации](https://core.telegram.org/bots/webapps#validating-data-received-via-the-web-app).

[//]: # (Перенести флоу верификации к нам)

## Отправка на сервер

Для того чтобы проводить авторизацию пользователя на сервере, разработчику
необходимо передавать те данные инициализации, которые были указаны при
запуске приложения TWA. Чтобы сделать себе жизнь проще, разработчик может
передавать их при каждом запросе к серверу, после чего на серверной стороне
проводить проверку подписи.

Рассмотрим простейший возможный пример с использованием такой библиотеки как
`axios`:

```typescript title="Пример передачи данных инициализации на сервер"
import axios from 'axios';

const initData = new URLSearchParams(window.location.hash.slice(1))
  .get('tgWebAppData');

if (initData === null) {
  throw new Error('Ooof! Something is wrong. Init data is missing');
}

// Create axios instance.  
const http = axios.create({
  headers: {
    // Append authorization header. 
    Authorization: `twa-init-data ${initData}`,
  }
});
```

В свою очередь на серверной стороне необходимо извлечь
заголовок `Authorization`,
проверить, что первая часть указывающая на тип авторизации,
является `twa-init-data`,
после чего извлечь данные инициализации и верифицировать их. С этого момента
сервер может доверять переданным параметрам и использовать, например,
указанную информацию о пользователе.

:::caution

В реальных приложениях рекомендуется использовать дополнительные механизмы
проверки данных инициализации. Например, добавить срок их истечения. Эту
проверку можно реализовать при помощи параметра `auth_date`, который отвечает
за дату создания параметров. Это решение позволит в случае кражи данных
инициализации предотвратить постоянное их использование злоумышленником.

:::

## Список параметров

В этой секции рассмотрен полный список параметров, используемых в данных
инициализации.

| Параметр       | Тип             | Описание                                                                                                                                                                                           |
|----------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| auth_date      | `number`        | Дата создания текущих данных инициализации. Является числом, представляющим собой Unix timestamp.                                                                                                  |
| can_send_after | `number`        | _Опциональный_. Время в секундах, после которого сообщение может быть отправлено через метод [answerWebAppQuery](https://core.telegram.org/bots/api#answerwebappquery).                            |
| chat           | [`Chat`](#chat) | _Опциональный_. Объект, содержащий информацию о чате с ботом, в котором было запущено приложение TWA. Возвращается только для приложений TWA, открытых через меню вложений.                        |
| hash           | `string`        | Подпись всех остальных данных инициализации. Используется в процессе проверки их [подписи](https://core.telegram.org/bots/webapps#validating-data-received-via-the-web-app).                       |
| query_id       | `string`        | _Опциональный_. Уникальный идентификатор сессии приложения TWA. Используется в процессе отправки сообщения через метод [answerWebAppQuery](https://core.telegram.org/bots/api#answerwebappquery).  |
| receiver       | [`User`](#user) | _Опциональный_. Объект, содержащий информацию о пользователе-собеседнике текущего пользователя. Возвращается только для приватных чатов, а также для приложений TWA, открытых через меню вложений. |
| start_param    | `string`        | _Опциональный_. Значение query-параметра `startattach` указанного в ссылке. Возвращается только для приложений TWA, открытых через меню вложений.                                                  |
| user           | [`User`](#user) | _Опциональный_. Объект, содержащий информацию о текущем пользователе.                                                                                                                              |

## Прочие типы

### Chat

Описывает информацию о чате.

| Поле      | Тип                              | Описание                                                                                                                                                    |
|-----------|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id        | `number`                         | Уникальный идентификатор чата.                                                                                                                              |
| photo_url | `string`                         | _Опциональное_. Ссылка на фотографию чата. Фото может иметь форматы `.jpeg` и `.svg`. Возвращается только для приложений TWA, открытых через меню вложений. |
| type      | `group`, `supergroup`, `channel` | Тип чата.                                                                                                                                                   |
| title     | `string`                         | Заголовок чата.                                                                                                                                             |
| username  | `string`                         | _Опциональное_. Логин пользователя чата.                                                                                                                    |

### User

Описывает информацию о пользователе или боте.

| Поле          | Тип       | Описание                                                                                                                                                                     |
|---------------|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| first_name    | `string`  | Имя бота или пользователя.                                                                                                                                                   |
| id            | `number`  | Идентификатор бота или пользователя.                                                                                                                                         |
| is_bot        | `boolean` | _Опциональное_. Является ли пользователь ботом.                                                                                                                              |
| is_premium    | `boolean` | _Опциональное_. Приобретён ли пользователем Telegram Premium.                                                                                                                |
| last_name     | `string`  | _Опциональное_. Фамилия пользователя.                                                                                                                                        |
| language_code | `string`  | _Опциональное_. [IETF](https://en.wikipedia.org/wiki/IETF_language_tag) язык пользователя.                                                                                   |
| photo_url     | `string`  | _Опциональное_. Ссылка на фотографию пользователя или бота. Фото может иметь форматы `.jpeg` и `.svg`. Возвращается только для приложений TWA, открытых через меню вложений. |
| username      | `string`  | _Опциональное_. Логин бота или пользователя.                                                                                                                                 |