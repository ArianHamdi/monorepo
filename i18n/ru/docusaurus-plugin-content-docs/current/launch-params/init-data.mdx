---
sidebar_position: 2
---

# Данные инициализации

В списке [параметров запуска](./about), данные инициализации располагаются в
параметре `tgWebAppData`. Они представляют собой набор данных, которые могут
быть важны в серверной части приложения.

Яркой особенностью данных инициализации является тот факт, что они могут
быть использованы как фактор аутентификации или авторизации. По этой причине
не стоит забывать и о безопасности приложения.

:::caution

Этот параметр не передается приложению TWA в случае, если оно было открыто
при помощи KeyboardButton (из клавиатуры в диалоге).

:::

## Извлечение

Для того чтобы извлечь данные инициализации, достаточно сначала получить
параметры запуска, после чего извлечь параметр `tgWebAppData` и поместить его
в конструктор `URLSearchParams`:

```typescript title="Пример извлечения данных инициализации"
// Получаем параметры запуска.
const hashParams = new URLSearchParams(window.location.hash.slice(1));

// Конвертируем в более удобный вид.
const initDataString = hashParams.get('tgWebAppData'); // user=...&query_id=...&...
const initData = new URLSearchParams(initDataString);

// Выводим подпись данных инициализации.
console.log(initData.get('hash')); // jsHS198czozxk7s8vvhhhrw
```

## Авторизация и аутентификация

Особенной чертой данных инициализации является возможность быть использованными
как фактор для авторизации или аутентификации. Дело в том, что сгенерированные
нативным приложением Telegram данные подписываются секретным ключом бота
Telegram, после чего сгенерированная подпись помещается рядом с самими
параметрами.

Таким образом, зная секретный ключ бота Telegram, у разработчика имеется
возможность проверить подпись данных и после этого им доверять.

Также, операция проверки подписи является достаточно быстрой и не требует
больших ресурсов сервера. Подробнее с алгоритмом подписи данных и верификации
можно ознакомиться
в [этой документации](https://core.telegram.org/bots/webapps#validating-data-received-via-the-web-app).

[//]: # (TODO: Перенести флоу верификации к нам)

## Отправка на сервер

Для того чтобы провести авторизацию пользователя на сервере, разработчику
необходимо передать те данные инициализации, которые были указаны при
запуске приложения TWA. Чтобы сделать себе жизнь проще, разработчик может
передавать их при каждом запросе к серверу, после чего на серверной стороне
проводить проверку подписи.

Рассмотрим простейший возможный пример с использованием такой библиотеки как
`axios`:

```typescript title="Пример передачи данных инициализации на сервер"
import axios from 'axios';

const hash = window.location.hash.slice(1);
const params = new URLSearchParams(hash);
const initData = params.get('tgWebAppData');

if (initData === null) {
  throw new Error('Ooof! Something is wrong. Init data is missing');
}

// Создаём экземпляр axios.
const http = axios.create({
  headers: {
    // Добавляем заголовок авторизации.
    Authorization: `twa-init-data ${initData}`,
  }
});
```

В свою очередь, на серверной стороне необходимо произвести следующие действия:

1. Получить значение заголовка `Authorization`;
2. Проверить, что первая его часть равна `twa-init-data`;
3. Получить данные инициализации и проверить их подпись.

В случае успеха выполнения этого алгоритма, серверная часть приложения может
доверять переданным данным инициализации.

:::tip

В реальных приложениях рекомендуется использовать дополнительные механизмы
проверки данных инициализации. Например, добавить срок их истечения. Эту
проверку можно реализовать при помощи параметра `auth_date`, который отвечает
за дату создания параметров. В случае кражи данных инициализации,
это решение позволит предотвратить постоянное их использование злоумышленником.

:::

## Список параметров

В этой секции рассмотрен полный список параметров, используемых в данных
инициализации.

<table>
<thead>
  <tr>
    <th>Параметр</th>
    <th>Тип</th>
    <th>Описание</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>auth_date</td>
    <td>
      <code>number</code>
    </td>
    <td>
      Дата создания данных инициализации. Является числом, представляющим
      собой Unix timestamp.
    </td>
  </tr>

  <tr>
    <td>can_send_after</td>
    <td>
      <code>number</code>
    </td>
    <td>
      <i>Опциональный</i>
      . Количество секунд, после которого сообщение может
      быть отправлено через
      метод <a href="https://core.telegram.org/bots/api#answerwebappquery">answerWebAppQuery</a>.
    </td>
  </tr>

  <tr>
    <td>chat_type</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <p>
        <i>Опциональный</i>
        . Тип чата, из которого было открыто приложение TWA. Значения:
      </p>
      <ul>
        <li>
          <code>sender</code>
        </li>
        <li>
          <code>private</code>
        </li>
        <li>
          <code>group</code>
        </li>
        <li>
          <code>supergroup</code>
        </li>
        <li>
          <code>channel</code>
        </li>
      </ul>
      <p style={{marginBottom: 0}}>
        Возвращается только для приложений, открытых по прямой ссылке.
      </p>
    </td>
  </tr>

  <tr>
    <td>chat_instance</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опциональный</i>
      . Глобальный идентификатор указывающий на чат, из которого было открыто
      приложение TWA. Возвращается только для приложений, открытых по прямой
      ссылке.
    </td>
  </tr>

  <tr>
    <td>chat</td>
    <td>
      <a href={'#chat'}>
        <code>Chat</code>
      </a>
    </td>
    <td>
      <i>Опциональный</i>
      . Объект, содержащий информацию о чате с ботом, в котором было запущено
      приложение TWA. Возвращается только для приложений TWA, открытых через
      меню вложений.
    </td>
  </tr>

  <tr>
    <td>hash</td>
    <td>
      <code>string</code>
    </td>
    <td>Подпись данных инициализации.</td>
  </tr>

  <tr>
    <td>query_id</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опциональный</i>
      . Уникальный идентификатор сессии приложения TWA. Используется в
      процессе
      отправки сообщения через
      метод <a href="https://core.telegram.org/bots/api#answerwebappquery">answerWebAppQuery</a>.
    </td>
  </tr>

  <tr>
    <td>receiver</td>
    <td>
      <a href={'#user'}>
        <code>User</code>
      </a>
    </td>
    <td>
      <i>Опциональный</i>
      . Объект, содержащий информацию о пользователе-собеседнике текущего
      пользователя. Возвращается только для приватных чатов, а также для
      приложений TWA, открытых через меню вложений.
    </td>
  </tr>

  <tr>
    <td>start_param</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опциональный</i>
      . Значение query-параметра <code>startattach</code> указанного в ссылке.
      Возвращается только для приложений TWA, открытых через меню вложений.
    </td>
  </tr>

  <tr>
    <td>user</td>
    <td>
      <a href={'#user'}>
        <code>User</code>
      </a>
    </td>
    <td>
      <i>Опциональный</i>
      . Объект, содержащий информацию о текущем пользователе.
    </td>
  </tr>

</tbody>
</table>

## Прочие типы

### Chat

Описывает информацию о чате.

<table>
<thead>
  <tr>
    <th>Поле</th>
    <th>Тип</th>
    <th>Описание</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>id</td>
    <td>
      <code>number</code>
    </td>
    <td>Уникальный идентификатор чата.</td>
  </tr>

  <tr>
    <td>photo_url</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опциональное</i>
      . Ссылка на фотографию чата. Фото может иметь
      форматы <code>.jpeg</code> и <code>.svg</code>.
      Возвращается только для приложений TWA, открытых через меню вложений.
    </td>
  </tr>

  <tr>
    <td>type</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <p>
        <i>Опциональный</i>
        . Тип чата. Значения:
      </p>
      <ul>
        <li>
          <code>group</code>
        </li>
        <li>
          <code>supergroup</code>
        </li>
        <li>
          <code>channel</code>
        </li>
      </ul>
    </td>
  </tr>

  <tr>
    <td>title</td>
    <td>
      <code>string</code>
    </td>
    <td>Заголовок чата.</td>
  </tr>

  <tr>
    <td>username</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <i>Опциональный</i>
      . Логин пользователя чата.
    </td>
  </tr>
</tbody>
</table>

### User

Описывает информацию о пользователе или боте.

| Поле          | Тип       | Описание                                                                                                                                                                     |
|---------------|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| first_name    | `string`  | Имя бота или пользователя.                                                                                                                                                   |
| id            | `number`  | Идентификатор бота или пользователя.                                                                                                                                         |
| is_bot        | `boolean` | _Опциональное_. Является ли пользователь ботом.                                                                                                                              |
| is_premium    | `boolean` | _Опциональное_. Приобретён ли пользователем Telegram Premium.                                                                                                                |
| last_name     | `string`  | _Опциональное_. Фамилия пользователя.                                                                                                                                        |
| language_code | `string`  | _Опциональное_. [IETF](https://en.wikipedia.org/wiki/IETF_language_tag) язык пользователя.                                                                                   |
| photo_url     | `string`  | _Опциональное_. Ссылка на фотографию пользователя или бота. Фото может иметь форматы `.jpeg` и `.svg`. Возвращается только для приложений TWA, открытых через меню вложений. |
| username      | `string`  | _Опциональное_. Логин бота или пользователя.                                                                                                                                 |