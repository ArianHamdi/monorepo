---
sidebar_position: 3
---

# События

События - это сигналы, отправляемые нативным приложением Telegram в случае,
если произошло какое-то внешнее действие. Равно как и методы, события
имеют своё уникальное наименование и параметры.

## Web

Как уже и было упомянуто в разделе [Методы](methods#web), web-версия Telegram
использует стандартный способ общения между двумя фреймами. Это означает, что
родительский фрейм имеет возможность отправлять событие при помощи вызова
такой функции как `window.postMessage`. Для обработки таких событий достаточно
добавить обработчик события `message` в глобальном объекте `window`:

```typescript
window.addEventListener('message', ...)
```

Нативное приложение отправляет событие со свойством `data: string`, которое
представляет собой JSON объект, приведённый к строке. Этот объект имеет
следующий интерфейс:

```typescript
interface MessageJSON {
  eventType: string;
  eventData: any;
}
```

Пример того, как могла бы происходить обработка события от нативного приложения
Telegram:

```typescript
window.addEventListener('message', ({data, origin}) => {
  // Check if data is really a string. Also, check if send data is from
  // verified source.
  if (typeof data !== 'string' || origin !== 'https://web.telegram.org') {
    return;
  }

  try {
    // Try parsing data as JSON as long as we expect it to JSON object
    // converted to string. In case, it is invalid, we will just jump to
    // catch and leave the function.
    const json = JSON.parse(data);

    // We need exactly object. Not null and array.
    if (typeof json !== 'object' || json === null || Array.isArray(json)) {
      return;
    }

    // Extract required properties, validate the type of eventType property.
    const {eventType, eventData} = json;

    if (typeof eventType !== 'string') {
      return;
    }

    // We got it!
    console.log(eventType, eventData);
  } catch (e) {
  }
})
```

## Desktop, mobile и Windows Phone

В случае, если нативное приложение Telegram захочет вызвать какое-либо событие,
оно произведёт вставку JavaScript-кода следующего содержания:

```typescript
window.Telegram.WebView.receiveEvent('popup_closed', {button_id: 'cancel'});
```

Вызываемая функция зависит от платформы:

- `window.TelegramGameProxy.receiveEvent` - desktop;
- `window.Telegram.WebView.receiveEvent` - mobile;
- `window.TelegramGameProxy_receiveEvent` - Windows Phone

Каждая из этих функций имеет одну и ту же сигнатуру:

```typescript
type ReceiveEvent = (eventType: string, eventData: unknown) => void;
```

Таким образом, решение для обработки таких событий является достаточно простым.
По указанному пути в зависимости от платформы, необходимо объявить свою
функцию-обработчик, которую и будет вызывать Telegram в случае появления
какого-либо события.

## Доступные события

Эта секция содержит список событий, отправляемых нативным приложением
Telegram: их наименования, параметры и описание. Заголовок секции указывает
на минимальную версию Telegram Web Apps, начиная с которой вложенные события
могут отправляться.

### v6.0

#### `invoice_closed`

Платежный счёт был закрыт.

<table>
  <thead>
  <tr>
    <th>Поле</th>
    <th>Тип</th>
    <th>Описание</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>slug</td>
    <td>
      <code>string</code>
    </td>
    <td>
      Переданный в процессе вызова метода&nbsp;
      <a href={'methods#web_app_open_invoice'}>
        <code>web_app_open_invoice</code>
      </a>
      &nbsp;
      параметр <code>slug</code>.
    </td>
  </tr>
  <tr>
    <td>status</td>
    <td>
      <code>string</code>
    </td>
    <td>
      <p>Статус платежа. Значения:</p>
      <ul>
        <li>
          <code>paid</code>
          , платеж был проведён
        </li>
        <li>
          <code>failed</code>
          , обработка платежа провалилась
        </li>
        <li>
          <code>pending</code>
          , платёж находится в обработке
        </li>
        <li>
          <code>cancelled</code>
          , платёж был отменён
        </li>
      </ul>
    </td>
  </tr>
  </tbody>
</table>

#### `main_button_pressed`

Пользователь нажал на [Главную Кнопку](../ui/main-button).

#### `popup_closed`

[Всплывающее окно](../ui/popup) было закрыто.

| Поле      | Тип      | Описание                                                                                                                                                                                  |
|-----------|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| button_id | `string` | _Опциональное_. Идентификатор кнопки, на которую нажал пользователь. В случае, если всплывающее окно было закрыто без нажатия на одну из переданных кнопок, это поле будет отсутствовать. |

#### `set_custom_style`

Событие, вызываемое web-версией Telegram. Его значением является контент
HTML-тега `<style/>`, которое может использовать разработчик. Набор стилей,
описанный в значении, может помочь разработчику стилизовать скролл-бар приложения
TWA.

:::info

Обработка этого события носит опциональный характер и может быть
проигнорирована.

:::

#### `theme_changed`

[Тема](../ui/theme-params) нативного приложения Telegram (включая переключение
на ночной либо дневной режим) была изменена.

| Поле         | Тип                      | Описание                                                                                       |
|--------------|--------------------------|------------------------------------------------------------------------------------------------|
| theme_params | `Record<string, string>` | Объект, в котором ключом является какой-либо ключ темы, а значение - цвет в формате `#RRGGBB`. |

```json title="Пример значения"
{
  "bg_color": "#212121",
  "text_color": "#ffffff",
  "hint_color": "#aaaaaa",
  "link_color": "#8774e1",
  "button_color": "#8774e1",
  "button_text_color": "#ffffff",
  "secondary_bg_color": "#0f0f0f"
}
```

#### `viewport_changed`

[Viewport](../ui/viewport) был изменён. К
примеру, когда пользователь начинает перетягивать приложение или в случае,
когда был вызван метод расширения viewport-а.

:::caution

Частоты отправки этого события недостаточно для того, чтобы гладко изменять
размер видимой области приложения. Скорее всего вам больше подойдет
использование стабильной высоты вместо текущей.

:::

| Поле            | Тип       | Описание                                                                                                                      |
|-----------------|-----------|-------------------------------------------------------------------------------------------------------------------------------|
| height          | `number`  | Текущая высота видимой области.                                                                                               |
| width           | `number`  | _Опциональное_. Текущая ширина видимой области.                                                                               |
| is_expanded     | `boolean` | Видимая область имеет максимальную высоту.                                                                                    |
| is_state_stable | `boolean` | Видимая область является стабильной. Иными словами, говорит о том, что её размер не будет изменен в следующий момент времени. |

### v6.1

#### `back_button_pressed`

Пользователь нажал на [Кнопку Назад](../ui/back-button).

#### `settings_button_pressed`

Пользователь нажал на элемент `Настройки` контекстного
меню шапки приложения. Не все приложения имеют эту кнопку.

[//]: # (TODO: Сослаться на документацию, в которой говорится какие именно приложения имеют этот функционал.)

### v6.4

#### `qr_text_received`

QR-сканнер просканировал QR-код и извлёк контент.

| Поле | Тип      | Описание                         |
|------|----------|----------------------------------|
| data | `string` | _Опциональное_. Контент QR-кода. |

#### `scan_qr_popup_closed`

QR-сканнер был закрыт.

#### `clipboard_text_received`

Текст из буфера обмена был извлечён. Не все приложения имеют доступ
к извлеченному контенту.

[//]: # (TODO: Сослаться на документацию, в которой говорится какие именно приложения имеют этот функционал.)

| Поле   | Тип                | Описание                                                                                                                              |
|--------|--------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| req_id | `string`           | Переданный в процессе вызова метода [`web_app_read_text_from_clipboard`](methods#web_app_read_text_from_clipboard) параметр `req_id`. |
| data   | `string` or `null` | _Опциональное_. Текст из буфера обмена. Значение будет иметь тип `string` в случае, если приложение имеет доступ к буферу обмена.     |
